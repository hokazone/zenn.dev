---
title: "ã€å…¬å¼Docsè£œè¶³ã€‘Vertex AI Matching Engineã¸ã®curlãƒªã‚¯ã‚¨ã‚¹ãƒˆæ–¹æ³•ï¼"
emoji: "ğŸ¥¹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "AI"
  - "GCP"
  - "VertexAI"
  - "curl"
published: true
published_at: "2024-05-14 13:15"
---

# ã¯ã˜ã‚ã«
æ¥­å‹™ã«ã¦ã€ã‚ˆã‚Šè‰¯ã„å•†å“ã‚’ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã™ã¹ãã€Google Cloudã®Vertex AI Matching Engineã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚
ä¾å­˜é–¢ä¿‚ã®å½±éŸ¿ã§ã€Rubyã®net/httpã‚’ç”¨ã„ã¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’è¡Œã†ã“ã¨ã«ãªã£ãŸã®ã§ã™ãŒã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æƒ…å ±ãŒå°‘ãªãè©°ã¾ã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã£ãŸã®ã§ã€å¿˜å‚™éŒ²ã¨ã—ã¦è¨˜äº‹ã«ã—ã¦ãŠãã¾ã™ã€‚
# å‰æ
IndexãŠã‚ˆã³Index Endpointã‚’ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
https://cloud.google.com/vertex-ai/docs/vector-search/deploy-index-public?hl=ja
# ã‚¯ã‚¨ãƒª
## æœ€è¿‘å‚ã®å–å¾—ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰
ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ã®Indexã«å¯¾ã—ã¦ã€è¿‘ä¼¼æœ€è¿‘å‚æ¢ç´¢ã‚’è¡Œã„ã¾ã™ã€‚
ã“ã¡ã‚‰å˜ä½“ã§ä½¿ã†ã“ã¨ã¯å°‘ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
```shell:curl
$ curl -X POST -H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://1957880287.asia-northeast1-181224308459.vdb.vertexai.goog/v1/projects/181224308459/locations/asia-northeast1/indexEndpoints/3370566089086861312:findNeighbors" \
-d '{deployedIndexId:"test_index_public1", "queries":[{datapoint:{"datapointId":"<DATA_POINT_ID>"}}], returnFullDatapoint:false}'
```
:::message
returnFullDatapointã‚’trueã«ã™ã‚‹ã¨ã€ãƒ™ã‚¯ãƒˆãƒ«å€¤ã‚„ãã®ä»–ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã‚‚è¿”ã—ã¾ã™
:::
ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚
```json:response
{
  "nearestNeighbors": [{
    "id": "test",
    "neighbors": [
      {
        "datapoint": {
          "datapointId": "test",
          "crowdingTag": {
            "crowdingAttribute": "0"
          }
        },
        "distance": 0.99999994039535522
      },
      {
        "datapoint": {
          "datapointId": "test_2",
          "crowdingTag": {
            "crowdingAttribute": "0"
          }
        },
        "distance": 0.0455654114484787
      }
    ]
  }]
}
```

## ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ï¼ˆallowï¼‰
å–ã£ã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰ã«åˆ¶é™ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€èµ¤è‰²ã®å•†å“ã®ã¿ã‚’è¡¨ç¤ºã—ãŸã„ï¼ã¨è¨€ã£ãŸã‚±ãƒ¼ã‚¹ã§ä¾¿åˆ©ã§ã™ã€‚
```shell:curl
$ curl -X POST -H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://1957880287.asia-northeast1-181224308459.vdb.vertexai.goog/v1/projects/181224308459/locations/asia-northeast1/indexEndpoints/3370566089086861312:findNeighbors" \
-d '{
  "deployedIndexId": "test_index_public1",
  "queries": [{
    "datapoint": {
      "datapointId": "<DATA_POINT_ID>",
      "restricts": [{
        "namespace": "color",
        "allowList": ["red"],
        "denyList": []
      }]
    }
  }],
  "returnFullDatapoint": false
}'
```

## ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ï¼ˆdenyï¼‰
ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰ã«é™¤å¤–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€é’è‰²ã®å•†å“ã‚’é™¤å¤–ã—ãŸã„ã¨è¨€ã£ãŸã‚±ãƒ¼ã‚¹ã«ä½¿ãˆã¾ã™ã€‚
```shell:curl
$ curl -X POST -H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://1957880287.asia-northeast1-181224308459.vdb.vertexai.goog/v1/projects/181224308459/locations/asia-northeast1/indexEndpoints/3370566089086861312:findNeighbors" \
-d '{
  "deployedIndexId": "test_index_public1",
  "queries": [{
    "datapoint": {
      "datapointId": "<DATA_POINT_ID>",
      "restricts": [{
        "namespace": "color",
        "allowList": [],
        "denyList": ["blue"]
      }]
    }
  }],
  "returnFullDatapoint": false
}'
```

## ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®æ¤œç´¢
Index Endpointå†…ã«ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ãŒè¿”ã£ã¦ãã¾ã™ã€‚
idsã«è¤‡æ•°æŒ‡å®šã‚„ã€returnFullDatapointã‚’trueã«ã—ã¦ä¸­èº«ã‚’çœç•¥ã›ãšã«è¡¨ç¤ºã§ãã¾ã™ã€‚
```shell:curl
$ curl -X POST -H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://1957880287.asia-northeast1-181224308459.vdb.vertexai.goog/v1/projects/181224308459/locations/asia-northeast1/indexEndpoints/3370566089086861312:readIndexDatapoints" \
-d '{
  "deployedIndexId": "test_index_public1",
  "ids": ["<DATA_POINT_ID>"],
  "returnFullDatapoint": true
}'
```

# Q&A
## æ¤œç´¢ã—ãŸæ™‚ã«distance 1ã¨ã—ã¦è‡ªåˆ†è‡ªèº«ãŒè¿”ã£ã¦ã“ãªã„
æœ€è¿‘å‚æ¢ç´¢ã®ç²¾åº¦ã‚„é€Ÿåº¦ã«ã‚ˆã‚Šã€distanceãŒ1ã«ãªã‚‰ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã—ãŸã„å ´åˆã¯ã€deny listã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
## ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¾ã‚Œã«403ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å½±éŸ¿ã«ã‚ˆã‚Šã€å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ’å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
metaã‚µãƒ¼ãƒãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã†ã¨å›é¿ã§ãã¾ã™ã€‚
```shell:curl
$ curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google" -s
> {"access_token":"ya29.c...","expires_in":2926,"token_type":"Bearer"}
```

# ã¾ã¨ã‚
GAã•ã‚ŒãŸã°ã‹ã‚Šã‹æƒ…å ±ãŒå°‘ãªãã€çµæ§‹èº“ãã¾ã—ãŸã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®æ§‹é€ ãŒé–“é•ã£ã¦ã„ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ã“ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ãŠã‹ã—ã„ãªã¨æ€ã£ãŸã‚‰ã€ã¾ãšã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å†ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼

# è¿½è¨˜
upsertæ™‚ã«allow listã«ã®ã¿è¿½åŠ ã—ãŸã‚‚ã®ã‚’denyã§ãã‚‹ç¾è±¡ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚
ãŠãã‚‰ããƒã‚°ã‹ã¨æ€ã„ã¾ã™ã€‚ã€‚ã€‚